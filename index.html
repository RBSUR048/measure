<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TWD97 å°ˆæ¥­æ¸¬é‡å…¨æ–¹ä½åŠ©æ‰‹</title>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --warning: #f29900; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); padding: 10px; margin: 0; font-size: 16px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
        h3 { margin: 0 0 10px 0; font-size: 1rem; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 2px; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--primary); color: white; }
        .btn-set { background: var(--success); color: white; margin-bottom: 5px; }
        .btn-add { background: var(--warning); color: white; }

        .tab-box { display: flex; margin-bottom: 10px; background: #ddd; border-radius: 5px; overflow: hidden; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-size: 0.95rem; }
        .tab-btn.active { background: white; color: var(--primary); font-weight: bold; }
        .content { display: none; }
        .content.active { display: block; }

        .scroll-table { overflow-x: auto; max-height: 400px; border: 1px solid #eee; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f1f1f1; position: sticky; top: 0; padding: 10px; text-align: left; z-index: 10; }
        td { border-bottom: 1px solid #eee; padding: 10px; }
        .active-tr { background-color: #fff9c4 !important; }
        .dms-text { color: #d93025; font-weight: bold; display: block; }
        .manual-input-box { background: #eef3f8; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>ğŸ“ 1. åŸºæº–é»è¨­å®š (Station/BS)</h3>
        <div class="grid">
            <div><label>æ¸¬ç«™ E (X)</label><input type="number" id="base_stE" step="0.001"></div>
            <div><label>æ¸¬ç«™ N (Y)</label><input type="number" id="base_stN" step="0.001"></div>
            <div><label>å¾Œè¦– E (X)</label><input type="number" id="base_bsE" step="0.001"></div>
            <div><label>å¾Œè¦– N (Y)</label><input type="number" id="base_bsN" step="0.001"></div>
        </div>
        <button class="btn-set" onclick="updateBase()">ç¢ºèªå®šå‘ (é–å®šåŸºæº–)</button>
        <div id="base_info" style="font-size: 0.85rem; text-align:center; color:#555; margin-top:5px; padding:5px; background:#fff;">è«‹è¼¸å…¥åº§æ¨™ä¸¦é»æ“Šç¢ºèª</div>
    </div>

    <div class="tab-box">
        <button id="b1" class="tab-btn active" onclick="showTab(1)">ç›®æ¨™é»æ”¾æ¨£</button>
        <button id="b2" class="tab-btn" onclick="showTab(2)">å…‰ç·šæ³•è£œé»</button>
    </div>

    <div id="tab1" class="content active">
        <div class="card">
            <div class="manual-input-box">
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                    <div style="grid-column: span 1;"><label>é»å</label><input type="text" id="m_name" placeholder="P1"></div>
                    <div><label>ç›®æ¨™ E</label><input type="number" id="m_e" step="0.001"></div>
                    <div><label>ç›®æ¨™ N</label><input type="number" id="m_n" step="0.001"></div>
                </div>
                <button class="btn-main" onclick="manualAdd()" style="margin-top:5px; padding:8px;">ï¼‹ æ‰‹å‹•åŠ å…¥é»ä½</button>
            </div>

            <div style="display: flex; gap:10px; align-items: center; margin-bottom:10px;">
                <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="loadCSV(this)">
                <button onclick="document.getElementById('csvFile').click()" style="background:#666; color:white; font-size:0.8rem; padding:8px; width:auto;">ğŸ“‚ æ‰¹æ¬¡åŒ¯å…¥ CSV</button>
                <button onclick="clearStakeTable()" style="background:#eee; color:#666; font-size:0.8rem; padding:8px; width:auto;">ğŸ§¹ æ¸…ç©ºæ¸…å–®</button>
            </div>

            <div class="scroll-table">
                <table id="stakeTable">
                    <thead><tr><th>é»å</th><th>åº§æ¨™(E/N)</th><th>æ”¾æ¨£(è·/è§’)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab2" class="content">
        <div class="card">
            <h3>ğŸ”„ ç¾å ´è£œé» (Radial)</h3>
            <div class="grid">
                <div style="grid-column: span 2;"><label>æ–°é»åç¨±</label><input type="text" id="r_name" value="NewP"></div>
                <div><label>æ’¥è§’ (åº¦)</label><input type="number" id="r_d"></div>
                <div style="display:flex; gap:2px;">
                    <div style="flex:1;"><label>åˆ†</label><input type="number" id="r_m"></div>
                    <div style="flex:1;"><label>ç§’</label><input type="number" id="r_s"></div>
                </div>
                <div style="grid-column: span 2;"><label>æ°´å¹³è·é›¢ (m)</label><input type="number" id="r_dist" step="0.001"></div>
            </div>
            <button class="btn-add" onclick="calcRadial()">è¨ˆç®—è£œé»ä¸¦å­˜æª”</button>
        </div>
        <div class="card">
            <h3>ğŸ“ è£œé»æˆæœç´€éŒ„</h3>
            <div class="scroll-table">
                <table id="radialTable">
                    <thead><tr><th>åç¨±</th><th>E åº§æ¨™</th><th>N åº§æ¨™</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    let global_ST = {e: null, n: null};
    let global_BS_Azimuth = null;

    function showTab(n) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab'+n).classList.add('active');
        document.getElementById('b'+n).classList.add('active');
    }

    function toDMS(deg) {
        let d = Math.floor(deg);
        let mF = (deg - d) * 60;
        let m = Math.floor(mF);
        let s = Math.round((mF - m) * 60);
        if (s>=60) { s=0; m++; }
        if (m>=60) { m=0; d++; }
        return `${d}Â°${m.toString().padStart(2,'0')}'${s.toString().padStart(2,'0')}"`;
    }

    function getAzi(e1, n1, e2, n2) {
        return (Math.atan2(e2 - e1, n2 - n1) * 180 / Math.PI + 360) % 360;
    }

    function updateBase() {
        const se = parseFloat(document.getElementById('base_stE').value);
        const sn = parseFloat(document.getElementById('base_stN').value);
        const be = parseFloat(document.getElementById('base_bsE').value);
        const bn = parseFloat(document.getElementById('base_bsN').value);
        if ([se, sn, be, bn].some(isNaN)) return alert("âš ï¸ åŸºæº–åº§æ¨™å¡«å¯«ä¸å®Œæ•´");
        
        global_ST = {e: se, n: sn};
        global_BS_Azimuth = getAzi(se, sn, be, bn);
        document.getElementById('base_info').innerHTML = `âœ… åŸºæº–å·²å®šï¼šå¾Œè¦–æ–¹ä½è§’ ${toDMS(global_BS_Azimuth)}`;
        refreshStakeTable();
    }

    // éµç›¤æ‰‹å‹•åŠ å…¥
    function manualAdd() {
        const name = document.getElementById('m_name').value || "P";
        const e = parseFloat(document.getElementById('m_e').value);
        const n = parseFloat(document.getElementById('m_n').value);
        if (isNaN(e) || isNaN(n)) return alert("è«‹è¼¸å…¥ç›®æ¨™é»åº§æ¨™");
        addStakeRow(name, e, n);
        // æ¸…ç©ºè¼¸å…¥æ¬„æ–¹ä¾¿ä¸‹ä¸€æ¬¡è¼¸å…¥
        document.getElementById('m_name').value = "P" + (document.querySelectorAll('#stakeTable tbody tr').length + 1);
        document.getElementById('m_e').value = "";
        document.getElementById('m_n').value = "";
    }

    function loadCSV(input) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split(/\r?\n/);
            lines.forEach(line => {
                const col = line.split(',');
                if (col.length >= 3) {
                    const name = col[0].trim(), te = parseFloat(col[1]), tn = parseFloat(col[2]);
                    if (!isNaN(te) && !isNaN(tn)) addStakeRow(name, te, tn);
                }
            });
        };
        reader.readAsText(input.files[0]);
    }

    function addStakeRow(name, e, n) {
        const tbody = document.querySelector('#stakeTable tbody');
        const row = tbody.insertRow(0); // æ–°å¢çš„é»æ”¾åœ¨æœ€ä¸Šé¢
        row.dataset.name = name; row.dataset.e = e; row.dataset.n = n;
        row.onclick = function() {
            document.querySelectorAll('#stakeTable tr').forEach(r => r.classList.remove('active-tr'));
            this.classList.add('active-tr');
        };
        renderStakeRow(row);
    }

    function renderStakeRow(row) {
        const e = parseFloat(row.dataset.e), n = parseFloat(row.dataset.n);
        let out = "--";
        if (global_BS_Azimuth !== null) {
            const dist = Math.sqrt(Math.pow(e-global_ST.e, 2) + Math.pow(n-global_ST.n, 2));
            const azi = getAzi(global_ST.e, global_ST.n, e, n);
            const angle = (azi - global_BS_Azimuth + 360) % 360;
            out = `<span class="dms-text">${dist.toFixed(3)}m</span><span class="dms-text">${toDMS(angle)}</span>`;
        }
        row.innerHTML = `<td>${row.dataset.name}</td><td>${e.toFixed(2)}<br>${n.toFixed(2)}</td><td>${out}</td>`;
    }

    function refreshStakeTable() {
        document.querySelectorAll('#stakeTable tbody tr').forEach(renderStakeRow);
    }

    function clearStakeTable() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ”¾æ¨£é»ä½å—ï¼Ÿ")) document.querySelector('#stakeTable tbody').innerHTML = "";
    }

    function calcRadial() {
        if (global_BS_Azimuth === null) return alert("è«‹å…ˆå®Œæˆã€Œç¢ºèªå®šå‘ã€");
        const dist = parseFloat(document.getElementById('r_dist').value);
        const deg = parseFloat(document.getElementById('r_d').value || 0), min = parseFloat(document.getElementById('r_m').value || 0), sec = parseFloat(document.getElementById('r_s').value || 0);
        if (isNaN(dist)) return alert("è«‹è¼¸å…¥æ°´å¹³è·é›¢");

        const targetAziRad = (global_BS_Azimuth + (deg + min/60 + sec/3600)) * Math.PI / 180;
        const nE = global_ST.e + dist * Math.sin(targetAziRad);
        const nN = global_ST.n + dist * Math.cos(targetAziRad);

        const tbody = document.querySelector('#radialTable tbody');
        const row = tbody.insertRow(0);
        row.innerHTML = `<td>${document.getElementById('r_name').value}</td><td>${nE.toFixed(3)}</td><td>${nN.toFixed(3)}</td>`;
    }
</script>
</body>
</html>